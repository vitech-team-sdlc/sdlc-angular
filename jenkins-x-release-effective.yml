buildPack: typescript
pipelineConfig:
  agent:
    image: nodejs12x
    label: jenkins-nodejs
  env:
  - name: APP_NAME
    value: mood-feed-frontend
  - name: BRANCH_NAME
    value: master
  - name: BUILD_NUMBER
    value: "11"
  - name: CONV_COMMIT_ERR_FILE
    value: check.failed
  - name: CONV_COMMIT_FILE
    value: commit.check
  - name: DOCKER_REGISTRY
    value: gcr.io
  - name: GIT_AUTHOR_EMAIL
    value: jenkins-x@googlegroups.com
  - name: GIT_AUTHOR_NAME
    value: jenkins-x-bot
  - name: GIT_COMMITTER_EMAIL
    value: jenkins-x@googlegroups.com
  - name: GIT_COMMITTER_NAME
    value: jenkins-x-bot
  - name: JOB_NAME
    value: vitech-team/mood-feed-frontend/master
  - name: JOB_SPEC
    value: type:postsubmit
  - name: JOB_TYPE
    value: postsubmit
  - name: PIPELINE_CONTEXT
    value: release
  - name: PIPELINE_KIND
    value: release
  - name: PULL_BASE_REF
    value: master
  - name: PULL_BASE_SHA
    value: 1398f3b85f0ba045a5ee9357de9ed82849ce5467
  - name: PULL_REFS
    value: master:1398f3b85f0ba045a5ee9357de9ed82849ce5467
  - name: REPO_NAME
    value: mood-feed-frontend
  - name: REPO_OWNER
    value: vitech-team
  - name: SOURCE_URL
    value: https://github.com/vitech-team/mood-feed-frontend.git
  - name: XDG_CONFIG_HOME
    value: /home/jenkins
  pipelines:
    overrides:
    - name: npm-install
      pipeline: pullRequest
      steps:
      - name: npm-install
        sh: npm install
      - name: npm-build
        sh: npm run build-prod
      - name: npm-lint
        sh: npm run lint
    - name: npm-install
      pipeline: release
      steps:
      - name: npm-install
        sh: npm install
      - name: npm-build
        sh: npm run build-prod
    - name: next-version
      stage: setVersion
      steps:
      - command: jx step next-version --semantic-release --filename package.json
        name: next-version
    post: {}
    pullRequest:
      pipeline:
        env:
        - name: APP_NAME
          value: mood-feed-frontend
        - name: BRANCH_NAME
          value: master
        - name: BUILD_NUMBER
          value: "11"
        - name: CONV_COMMIT_ERR_FILE
          value: check.failed
        - name: CONV_COMMIT_FILE
          value: commit.check
        - name: DOCKER_REGISTRY
          value: gcr.io
        - name: GIT_AUTHOR_EMAIL
          value: jenkins-x@googlegroups.com
        - name: GIT_AUTHOR_NAME
          value: jenkins-x-bot
        - name: GIT_COMMITTER_EMAIL
          value: jenkins-x@googlegroups.com
        - name: GIT_COMMITTER_NAME
          value: jenkins-x-bot
        - name: JOB_NAME
          value: vitech-team/mood-feed-frontend/master
        - name: JOB_SPEC
          value: type:postsubmit
        - name: JOB_TYPE
          value: postsubmit
        - name: PIPELINE_CONTEXT
          value: release
        - name: PIPELINE_KIND
          value: release
        - name: PULL_BASE_REF
          value: master
        - name: PULL_BASE_SHA
          value: 1398f3b85f0ba045a5ee9357de9ed82849ce5467
        - name: PULL_REFS
          value: master:1398f3b85f0ba045a5ee9357de9ed82849ce5467
        - name: REPO_NAME
          value: mood-feed-frontend
        - name: REPO_OWNER
          value: vitech-team
        - name: SOURCE_URL
          value: https://github.com/vitech-team/mood-feed-frontend.git
        - name: XDG_CONFIG_HOME
          value: /home/jenkins
        options:
          containerOptions:
            env:
            - name: APP_NAME
              value: mood-feed-frontend
            - name: BRANCH_NAME
              value: master
            - name: BUILD_NUMBER
              value: "11"
            - name: CONV_COMMIT_ERR_FILE
              value: check.failed
            - name: CONV_COMMIT_FILE
              value: commit.check
            - name: DOCKER_REGISTRY
              value: gcr.io
            - name: GIT_AUTHOR_EMAIL
              value: jenkins-x@googlegroups.com
            - name: GIT_AUTHOR_NAME
              value: jenkins-x-bot
            - name: GIT_COMMITTER_EMAIL
              value: jenkins-x@googlegroups.com
            - name: GIT_COMMITTER_NAME
              value: jenkins-x-bot
            - name: JOB_NAME
              value: vitech-team/mood-feed-frontend/master
            - name: JOB_SPEC
              value: type:postsubmit
            - name: JOB_TYPE
              value: postsubmit
            - name: PIPELINE_CONTEXT
              value: release
            - name: PIPELINE_KIND
              value: release
            - name: PULL_BASE_REF
              value: master
            - name: PULL_BASE_SHA
              value: 1398f3b85f0ba045a5ee9357de9ed82849ce5467
            - name: PULL_REFS
              value: master:1398f3b85f0ba045a5ee9357de9ed82849ce5467
            - name: REPO_NAME
              value: mood-feed-frontend
            - name: REPO_OWNER
              value: vitech-team
            - name: SOURCE_URL
              value: https://github.com/vitech-team/mood-feed-frontend.git
            - name: XDG_CONFIG_HOME
              value: /home/jenkins
            name: ""
            resources:
              requests:
                cpu: 400m
                memory: 512Mi
            securityContext:
              privileged: true
            volumeMounts:
            - mountPath: /home/jenkins
              name: workspace-volume
          volumes:
          - emptyDir: {}
            name: workspace-volume
        stages:
        - agent:
            image: nodejs12x
          dir: /workspace/source
          name: from-build-pack
          steps:
          - command: $(commitsar > $CONV_COMMIT_FILE) || { echo 'commit check failed' >> $CONV_COMMIT_ERR_FILE; exit 0; }
            dir: /workspace/source
            image: aevea/commitsar:latest
            name: prebuild-conventionalcommits-check
          - command: cat $CONV_COMMIT_FILE
            dir: /workspace/source
            image: nodejs12x
            name: prebuild-conventionalcommits-print
          - command: |
              if [ -f "$CONV_COMMIT_ERR_FILE" ]; then
                  jx step pr comment -c "$(echo -e "[Conventional Commits](https://www.conventionalcommits.org): **Check Failed** :cursing_face: \n HASH | ERROR | MSG \n --|--|-- \n $(cat  $CONV_COMMIT_FILE | grep "|" | awk  -F"|" '{printf "%s | %s | %s", $2, $3, $4;} {print ""}' | grep -v -e '^[[:space:]]*$' | tail -n +2 | grep '[[:alnum:]]')")"
                  exit 1;
              else
                 echo 'COMMIT MESSAGE CHECK PASSED!'
              fi
            dir: /workspace/source
            image: nodejs12x
            name: prebuild-conventionalcommits-comment
          - command: jx step credential -s npm-token -k file -f /builder/home/.npmrc --optional=true
            dir: /workspace/source
            image: nodejs12x
            name: build-npmrc
          - command: npm install
            dir: /workspace/source
            image: nodejs12x
            name: build-npm-install
          - command: npm run build-prod
            dir: /workspace/source
            image: nodejs12x
            name: build-npm-build
          - command: npm run lint
            dir: /workspace/source
            image: nodejs12x
            name: build-npm-lint
          - command: CI=true DISPLAY=:99 npm test
            dir: /workspace/source
            image: nodejs12x
            name: build-npm-test
          - command: /kaniko/executor $KANIKO_FLAGS --cache=true --cache-dir=/workspace --context=/workspace/source --dockerfile=/workspace/source/Dockerfile --destination=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/$APP_NAME:$VERSION --cache-repo=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/cache
            dir: /workspace/source
            env:
            - name: NO_GOOGLE_APPLICATION_CREDENTIALS
              value: "true"
            - name: GOOGLE_APPLICATION_CREDENTIALS
            image: gcr.io/kaniko-project/executor
            name: build-container-build
          - command: jx preview create --app $APP_NAME
            dir: /workspace/source
            image: gcr.io/jenkinsxio/jx-cli
            name: promote-jx-preview
    release:
      pipeline:
        env:
        - name: APP_NAME
          value: mood-feed-frontend
        - name: BRANCH_NAME
          value: master
        - name: BUILD_NUMBER
          value: "11"
        - name: CONV_COMMIT_ERR_FILE
          value: check.failed
        - name: CONV_COMMIT_FILE
          value: commit.check
        - name: DOCKER_REGISTRY
          value: gcr.io
        - name: GIT_AUTHOR_EMAIL
          value: jenkins-x@googlegroups.com
        - name: GIT_AUTHOR_NAME
          value: jenkins-x-bot
        - name: GIT_COMMITTER_EMAIL
          value: jenkins-x@googlegroups.com
        - name: GIT_COMMITTER_NAME
          value: jenkins-x-bot
        - name: JOB_NAME
          value: vitech-team/mood-feed-frontend/master
        - name: JOB_SPEC
          value: type:postsubmit
        - name: JOB_TYPE
          value: postsubmit
        - name: PIPELINE_CONTEXT
          value: release
        - name: PIPELINE_KIND
          value: release
        - name: PULL_BASE_REF
          value: master
        - name: PULL_BASE_SHA
          value: 1398f3b85f0ba045a5ee9357de9ed82849ce5467
        - name: PULL_REFS
          value: master:1398f3b85f0ba045a5ee9357de9ed82849ce5467
        - name: REPO_NAME
          value: mood-feed-frontend
        - name: REPO_OWNER
          value: vitech-team
        - name: SOURCE_URL
          value: https://github.com/vitech-team/mood-feed-frontend.git
        - name: XDG_CONFIG_HOME
          value: /home/jenkins
        options:
          containerOptions:
            env:
            - name: APP_NAME
              value: mood-feed-frontend
            - name: BRANCH_NAME
              value: master
            - name: BUILD_NUMBER
              value: "11"
            - name: CONV_COMMIT_ERR_FILE
              value: check.failed
            - name: CONV_COMMIT_FILE
              value: commit.check
            - name: DOCKER_REGISTRY
              value: gcr.io
            - name: GIT_AUTHOR_EMAIL
              value: jenkins-x@googlegroups.com
            - name: GIT_AUTHOR_NAME
              value: jenkins-x-bot
            - name: GIT_COMMITTER_EMAIL
              value: jenkins-x@googlegroups.com
            - name: GIT_COMMITTER_NAME
              value: jenkins-x-bot
            - name: JOB_NAME
              value: vitech-team/mood-feed-frontend/master
            - name: JOB_SPEC
              value: type:postsubmit
            - name: JOB_TYPE
              value: postsubmit
            - name: PIPELINE_CONTEXT
              value: release
            - name: PIPELINE_KIND
              value: release
            - name: PULL_BASE_REF
              value: master
            - name: PULL_BASE_SHA
              value: 1398f3b85f0ba045a5ee9357de9ed82849ce5467
            - name: PULL_REFS
              value: master:1398f3b85f0ba045a5ee9357de9ed82849ce5467
            - name: REPO_NAME
              value: mood-feed-frontend
            - name: REPO_OWNER
              value: vitech-team
            - name: SOURCE_URL
              value: https://github.com/vitech-team/mood-feed-frontend.git
            - name: XDG_CONFIG_HOME
              value: /home/jenkins
            name: ""
            resources:
              requests:
                cpu: 400m
                memory: 512Mi
            securityContext:
              privileged: true
            volumeMounts:
            - mountPath: /home/jenkins
              name: workspace-volume
          volumes:
          - emptyDir: {}
            name: workspace-volume
        stages:
        - agent:
            image: nodejs12x
          dir: /workspace/source
          name: from-build-pack
          steps:
          - command: jx step git credentials
            dir: /workspace/source
            image: nodejs12x
            name: setup-jx-git-credentials
          - command: jx step credential -s npm-token -k file -f /builder/home/.npmrc --optional=true
            dir: /workspace/source
            image: nodejs12x
            name: build-npmrc
          - command: npm install
            dir: /workspace/source
            image: nodejs12x
            name: build-npm-install
          - command: npm run build-prod
            dir: /workspace/source
            image: nodejs12x
            name: build-npm-build
          - command: CI=true DISPLAY=:99 npm test
            dir: /workspace/source
            image: nodejs12x
            name: build-npm-test
          - command: /kaniko/executor $KANIKO_FLAGS --cache=true --cache-dir=/workspace --context=/workspace/source --dockerfile=/workspace/source/Dockerfile --destination=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/$APP_NAME:$VERSION --cache-repo=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/cache
            dir: /workspace/source
            env:
            - name: NO_GOOGLE_APPLICATION_CREDENTIALS
              value: "true"
            - name: GOOGLE_APPLICATION_CREDENTIALS
            image: gcr.io/kaniko-project/executor
            name: build-container-build
          - command: jx step changelog --batch-mode --version v${VERSION}
            dir: /workspace/source/charts/mood-feed-frontend
            image: gcr.io/jenkinsxio/builder-go
            name: promote-changelog
          - command: jx step helm release
            dir: /workspace/source/charts/mood-feed-frontend
            image: gcr.io/jenkinsxio/builder-go
            name: promote-helm-release
          - command: jx promote -b --all-auto --timeout 1h
            dir: /workspace/source/charts/mood-feed-frontend
            image: gcr.io/jenkinsxio/jx-cli
            name: promote-jx-promote
      setVersion:
        steps:
        - image: nodejs
          steps:
          - command: jx step next-version --semantic-release --filename package.json
            name: next-version
          - name: tag-version
            sh: jx step tag --version \$(cat VERSION)
        - command: jx step next-version --semantic-release --filename package.json
          name: next-version
        - image: gcr.io/jenkinsxio/builder-go
          name: update-version
          sh: jx step tag --version \$(cat VERSION) --no-apply
        - comment: lets release the versioned kubernetes resources for consumption via kubectl/kpt/kustomize
          image: gcr.io/jenkinsxio/jx-cli
          name: helm-template
          sh: 'echo disabled: jx gitops helm template --optional'
        - image: gcr.io/jenkinsxio/builder-go
          name: tag-version
          sh: jx step tag --version \$(cat VERSION)
