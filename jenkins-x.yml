buildPack: typescript
pipelineConfig:
  agent:
    image: nodejs12x
  env:
    - value: gcr.io
      name: DOCKER_REGISTRY
    - name: GIT_AUTHOR_EMAIL
      value: jenkins-x@googlegroups.com
    - name: GIT_AUTHOR_NAME
      value: jenkins-x-bot
    - name: GIT_COMMITTER_EMAIL
      value: jenkins-x@googlegroups.com
    - name: GIT_COMMITTER_NAME
      value: jenkins-x-bot
    - name: XDG_CONFIG_HOME
      value: /home/jenkins
    - name: CONV_COMMIT_ERR_FILE
      value: check.failed
    - name: CONV_COMMIT_FILE
      value: commit.check
  pipelines:
    pullRequest:
      preBuild:
        steps:
          - name: conventionalcommits-check
            image: aevea/commitsar:latest
            command: $(commitsar > $CONV_COMMIT_FILE) || { echo 'commit check failed' >> $CONV_COMMIT_ERR_FILE; exit 0; }
          - name: conventionalcommits-print
            command: cat $CONV_COMMIT_FILE
          - name: conventionalcommits-comment
            command: |
              if [ -f "$CONV_COMMIT_ERR_FILE" ]; then
                  jx step pr comment -c "$(echo -e "[Conventional Commits](https://www.conventionalcommits.org): **Check Failed** :cursing_face: \n HASH | ERROR | MSG \n --|--|-- \n $(cat  $CONV_COMMIT_FILE | grep "|" | awk  -F"|" '{printf "%s | %s | %s", $2, $3, $4;} {print ""}' | grep -v -e '^[[:space:]]*$' | tail -n +2 | grep '[[:alnum:]]')")"
                  exit 1;
              else
                 echo 'COMMIT MESSAGE CHECK PASSED!'
              fi
    overrides:
      - pipeline: pullRequest
        name: npm-install
        steps:
          - sh: npm install
            name: npm-install
          - sh: npm run build-prod
            name: npm-build
          - sh: npm run lint
            name: npm-lint
      - pipeline: release
        name: npm-install
        steps:
          - sh: npm install
            name: npm-install
          - sh: npm run build-prod
            name: npm-build
      - stage: setVersion
        name: next-version
        steps:
          - name: next-version
            command: jx step next-version --semantic-release --filename package.json
